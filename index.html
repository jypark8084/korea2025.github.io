const express = require("express");
const axios = require("axios");
const bodyParser = require("body-parser");

const app = express();
app.use(bodyParser.json());

const GITHUB_REPO = "jypark8084/korea2025-server-data";
const FILE_PATH = "data.json";
const GITHUB_TOKEN = process.env.GITHUB_TOKEN;
const BRANCH = "main";

const headers = {
  Authorization: `token ${GITHUB_TOKEN}`,
  Accept: "application/vnd.github.v3+json",
};

// 📥 데이터 불러오기
app.get("/api/load", async (req, res) => {
  try {
    const response = await axios.get(
      `https://raw.githubusercontent.com/${GITHUB_REPO}/${BRANCH}/${FILE_PATH}`
    );
    console.log("📥 출석 데이터 불러오기 성공");
    res.json(JSON.parse(response.data));
  } catch (e) {
    console.error("❌ 출석 데이터 불러오기 실패:", e.toString());
    res.status(500).json({ success: false, error: "불러오기 실패", detail: e.toString() });
  }
});

// 📤 데이터 저장 (출석 처리)
app.post("/api/save", async (req, res) => {
  try {
    const { text } = req.body;
    const name = String(text || "").trim();

    if (!name) {
      return res.status(400).json({ success: false, error: "닉네임이 비어 있습니다." });
    }

    const { data: current } = await axios.get(
      `https://api.github.com/repos/${GITHUB_REPO}/contents/${FILE_PATH}`,
      { headers }
    );

    const decoded = Buffer.from(current.content, "base64").toString();
    const json = JSON.parse(decoded);
    json.attendance = json.attendance || {};

    const today = new Date().toDateString();
    const yesterday = new Date(Date.now() - 86400000).toDateString();

    const existing = json.attendance[name] || {
      count: 0,
      streak: 0,
      lastDate: ""
    };

    if (existing.lastDate === today) {
      console.log(`⚠️ ${name}님은 이미 오늘 출석함`);
      return res.json({ success: true, message: "이미 오늘 출석했습니다." });
    }

    if (existing.lastDate === yesterday) {
      existing.streak += 1;
    } else {
      existing.streak = 1;
    }

    existing.count += 1;
    existing.lastDate = today;

    json.attendance[name] = existing;

    const updatedContent = Buffer.from(JSON.stringify(json, null, 2)).toString("base64");

    const putResponse = await axios.put(
      `https://api.github.com/repos/${GITHUB_REPO}/contents/${FILE_PATH}`,
      {
        message: `출석: ${name}`,
        content: updatedContent,
        sha: current.sha,
        branch: BRANCH,
      },
      { headers }
    );

    console.log(`✅ 저장됨: ${name} (commit: ${putResponse.data.commit.sha})`);
    res.json({ success: true, message: `${name} 출석이 저장되었습니다.` });
  } catch (e) {
    console.error("❌ 저장 중 오류:", e.response?.data || e.toString());
    res.status(500).json({ success: false, error: "저장 실패", detail: e.toString() });
  }
});

app.listen(3000, () => {
  console.log("🚀 서버 실행 중 (port 3000)");
});
