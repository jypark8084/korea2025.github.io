const express = require("express");
const axios = require("axios");
const bodyParser = require("body-parser");

const app = express();
app.use(bodyParser.json());

const GITHUB_REPO = "jypark8084/korea2025-server-data";
const FILE_PATH = "data.json";
const GITHUB_TOKEN = process.env.GITHUB_TOKEN;
const BRANCH = "main";

const headers = {
  Authorization: `token ${GITHUB_TOKEN}`,
  Accept: "application/vnd.github.v3+json",
};

// ðŸ“¥ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
app.get("/api/load", async (req, res) => {
  try {
    const response = await axios.get(
      `https://raw.githubusercontent.com/${GITHUB_REPO}/${BRANCH}/${FILE_PATH}`
    );
    console.log("ðŸ“¥ ì¶œì„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì„±ê³µ");
    res.json(JSON.parse(response.data));
  } catch (e) {
    console.error("âŒ ì¶œì„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", e.toString());
    res.status(500).json({ success: false, error: "ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", detail: e.toString() });
  }
});

// ðŸ“¤ ë°ì´í„° ì €ìž¥ (ì¶œì„ ì²˜ë¦¬)
app.post("/api/save", async (req, res) => {
  try {
    const { text } = req.body;
    const name = String(text || "").trim();

    if (!name) {
      return res.status(400).json({ success: false, error: "ë‹‰ë„¤ìž„ì´ ë¹„ì–´ ìžˆìŠµë‹ˆë‹¤." });
    }

    const { data: current } = await axios.get(
      `https://api.github.com/repos/${GITHUB_REPO}/contents/${FILE_PATH}`,
      { headers }
    );

    const decoded = Buffer.from(current.content, "base64").toString();
    const json = JSON.parse(decoded);
    json.attendance = json.attendance || {};

    const today = new Date().toDateString();
    const yesterday = new Date(Date.now() - 86400000).toDateString();

    const existing = json.attendance[name] || {
      count: 0,
      streak: 0,
      lastDate: ""
    };

    if (existing.lastDate === today) {
      console.log(`âš ï¸ ${name}ë‹˜ì€ ì´ë¯¸ ì˜¤ëŠ˜ ì¶œì„í•¨`);
      return res.json({ success: true, message: "ì´ë¯¸ ì˜¤ëŠ˜ ì¶œì„í–ˆìŠµë‹ˆë‹¤." });
    }

    if (existing.lastDate === yesterday) {
      existing.streak += 1;
    } else {
      existing.streak = 1;
    }

    existing.count += 1;
    existing.lastDate = today;

    json.attendance[name] = existing;

    const updatedContent = Buffer.from(JSON.stringify(json, null, 2)).toString("base64");

    const putResponse = await axios.put(
      `https://api.github.com/repos/${GITHUB_REPO}/contents/${FILE_PATH}`,
      {
        message: `ì¶œì„: ${name}`,
        content: updatedContent,
        sha: current.sha,
        branch: BRANCH,
      },
      { headers }
    );

    console.log(`âœ… ì €ìž¥ë¨: ${name} (commit: ${putResponse.data.commit.sha})`);
    res.json({ success: true, message: `${name} ì¶œì„ì´ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.` });
  } catch (e) {
    console.error("âŒ ì €ìž¥ ì¤‘ ì˜¤ë¥˜:", e.response?.data || e.toString());
    res.status(500).json({ success: false, error: "ì €ìž¥ ì‹¤íŒ¨", detail: e.toString() });
  }
});

app.listen(3000, () => {
  console.log("ðŸš€ ì„œë²„ ì‹¤í–‰ ì¤‘ (port 3000)");
});
